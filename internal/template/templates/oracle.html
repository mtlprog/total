<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Admin — Total</title>
    <meta name="description" content="Deploy, resolve, and manage prediction markets on Total.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    {{template "styles" .}}
</head>
<body>
    <div class="container">
        {{template "header" .}}
        <main class="main">

            <div style="margin-bottom: 2rem;">
                <span class="section-label" style="display: inline-block; margin-bottom: 0.5rem;">Oracle Administration</span>
            </div>

            <div class="panel">
                <h3 class="panel-title">Oracle Info</h3>
                <div class="meta-row">
                    <span class="meta-key">Oracle Public Key</span>
                    <span class="meta-val" style="font-size: 0.85rem; word-break: break-all;">{{.OraclePublicKey}}</span>
                </div>
                {{if .FactoryContract}}
                <div class="meta-row">
                    <span class="meta-key">Factory Contract</span>
                    <span class="meta-val" style="font-size: 0.85rem; word-break: break-all;">{{.FactoryContract}}</span>
                </div>
                {{end}}
            </div>

            <div class="panel">
                <h3 class="panel-title">Deploy New Market</h3>
                <p style="font-size: 0.825rem; color: var(--text-2); margin-bottom: 1.25rem;">
                    Deploy a new prediction market via the factory contract.
                </p>

                <div class="warning-box">
                    <strong>Step 1:</strong> Upload metadata JSON to IPFS via <a href="https://app.pinata.cloud/" target="_blank" rel="noopener">Pinata</a> first.
                    <pre>{
  "question": "Will BTC reach $100k by end of 2025?",
  "description": "Resolution criteria...",
  "resolution_source": "coinbase.com",
  "category": "crypto",
  "end_date": "2025-12-31T23:59:59Z",
  "created_at": "2025-01-01T00:00:00Z",
  "created_by": "G..."
}</pre>
                </div>

                <form method="POST" action="/deploy">
                    <div class="form-group">
                        <label class="form-label">IPFS Metadata Hash (CID) *</label>
                        <input class="form-input" type="text" name="metadata_hash" required placeholder="QmXxx... or bafyxxx...">
                        <span class="form-help">The IPFS CID of your uploaded metadata JSON.</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Liquidity Parameter (b)</label>
                        <input class="form-input" type="number" name="liquidity_param" value="{{.DefaultLiquidityParam}}" min="1" step="0.01">
                        <span class="form-help">Higher = more liquidity, lower price impact. Recommended: 100–1000.</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Initial Funding (collateral tokens)</label>
                        <input class="form-input" type="number" name="initial_funding" value="72" min="1" step="0.01">
                        <span class="form-help">Must exceed b × ln(2) ≈ b × 0.693. Use at least b × 0.70 as a safe minimum.</span>
                    </div>

                    <button type="submit" class="btn btn-primary">Generate Deploy Transaction</button>
                </form>
            </div>

            {{if .MarketsError}}
            <div class="error-box">
                <div class="error-message">{{.MarketsError}}</div>
            </div>
            {{end}}

            {{if .Markets}}

            <div class="panel">
                <h3 class="panel-title">Resolve Market</h3>
                <p style="font-size: 0.825rem; color: var(--text-2); margin-bottom: 1.25rem;">
                    Resolve an active market by selecting the winning outcome.
                </p>

                <form method="POST" action="" id="resolve-form">
                    <div class="form-group">
                        <label class="form-label">Select Market</label>
                        <select class="form-input" name="market_id" required onchange="document.getElementById('resolve-form').action = '/market/' + this.value + '/resolve';">
                            <option value="">Choose a market...</option>
                            {{range .Markets}}
                            {{if not .IsResolved}}
                            <option value="{{.ID}}">{{truncate .Question 50}} ({{shortID .ID}})</option>
                            {{end}}
                            {{end}}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Winning Outcome</label>
                        <div class="outcome-group">
                            <div class="outcome-option yes">
                                <input type="radio" name="outcome" value="YES" id="resolve-yes" required>
                                <label for="resolve-yes">Yes</label>
                            </div>
                            <div class="outcome-option no">
                                <input type="radio" name="outcome" value="NO" id="resolve-no">
                                <label for="resolve-no">No</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn">Generate Resolve Transaction</button>
                </form>
            </div>

            <div class="panel">
                <h3 class="panel-title">Withdraw Remaining Pool</h3>
                <p style="font-size: 0.825rem; color: var(--text-2); margin-bottom: 1.25rem;">
                    Withdraw losers' bets and fees from resolved markets. Funds reserved for unclaimed winners are protected and excluded from withdrawal automatically.
                </p>

                <form method="POST" action="" id="withdraw-form">
                    <input type="hidden" name="oracle_public_key" value="{{.OraclePublicKey}}">

                    <div class="form-group">
                        <label class="form-label">Select Resolved Market</label>
                        <select class="form-input" name="market_id" required onchange="document.getElementById('withdraw-form').action = '/market/' + this.value + '/withdraw';">
                            <option value="">Choose a market...</option>
                            {{range .Markets}}
                            {{if .IsResolved}}
                            <option value="{{.ID}}">{{truncate .Question 50}} ({{shortID .ID}})</option>
                            {{end}}
                            {{end}}
                        </select>
                    </div>

                    <button type="submit" class="btn">Generate Withdraw Transaction</button>
                </form>
            </div>

            {{end}}

            <div class="panel">
                <h3 class="panel-title">How It Works</h3>
                <ol class="steps">
                    <li>Create metadata JSON with question, description, resolution criteria</li>
                    <li>Upload JSON to IPFS and copy the CID</li>
                    <li>Fill in the deploy form above with IPFS CID and parameters</li>
                    <li>Sign the generated XDR with your oracle wallet</li>
                    <li>Submit the signed transaction to Stellar network</li>
                    <li>Market appears on the markets list automatically</li>
                    <li>When outcome is known, resolve the market</li>
                    <li>After claims period, withdraw remaining pool</li>
                </ol>
            </div>

        </main>
    </div>
    {{template "footer" .}}
</body>
</html>
